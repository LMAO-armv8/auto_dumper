name: Dump and Push

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  GITHUB_USERNAME: lmao-armv8
  GITHUB_EMAIL: chaitanya4g9@sasi.ac.in
  DUMP_TOKEN: ${{ secrets.DUMP_TOKEN }}

jobs:
  ubuntu:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      max-parallel: 2
      matrix:
        include:
          - model: "SM-S901E"
            region: "INS"
            codename: "r0q"
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Configuring git
        run: |
          git config --global user.name $GITHUB_USERNAME
          git config --global user.email $GITHUB_EMAIL

      - name: Clone dumping tool
        run: git clone https://github.com/DroidDumps/phoenix_firmware_dumper dumper

      - name: Copy the secrets and create .github_orgname
        run: |
          cd dumper
          echo "${{ secrets.DUMP_TOKEN }}" > .github_token
          echo "LMAO-dumps" > .github_orgname

      - name: Dumping the firmware
        run: |
          cd dumper
          # Store the current working directory in a variable
          CURRENT_DIR=$(pwd)
          # Print the current working directory
          echo "Current working directory: $CURRENT_DIR"
          
          # Create a directory for firmware dumping
          mkdir input

          # Install samfirm tool
          sudo wget -O /usr/bin/samfirm https://github.com/ananjaser1211/SamFirm.NET/releases/latest/download/linux-x64 && sudo chmod +x /usr/bin/samfirm

          # Use samfirm to download your firmware
          samfirm -m ${{ matrix.model }} -r ${{ matrix.region }}
          zip -r input/file.zip ${{ matrix.model }}_${{ matrix.region }}/*
          rm -rf ${{ matrix.model }}_${{ matrix.region }}
          cd $CURRENT_DIR

          # Execute the dumper.sh script on all files in the firmware_dump directory
          ./dumper.sh input/*

      - name: Cleaning the area
        run: |
          cd ../$CURRENT_DIR
          rm -rf *
